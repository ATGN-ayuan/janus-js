var Janus=Janus||{};Janus.Connection=function(a){if(this.server=a.server,this.session=a.session,this.options={},this.ws=null,this.connected=!1,_.defaults(a,{success:_.noop,error:_.noop}),0===this.server.lastIndexOf("http://",0))this.options=_.defaults(_.pick(a),{pollTimeout:6e4,pollFrequency:500,maxPollSize:1,maxPollRetries:3}),this._send=_.bind(this._httpSend,this),this._close=_.bind(this._httpClose,this),this._httpSetup(a);else{if(0!==this.server.lastIndexOf("ws://",0))throw"Server '"+this.server+"' has unsupported scheme.";this.options=_.defaults(_.pick(a),{keepAliveFrequency:3e4}),this._send=_.bind(this._wsSend,this),this._close=_.bind(this._wsClose,this),this._wsSetup(a)}},_.extend(Janus.Connection,Backbone.Events),Janus.Connection.prototype.send=function(a,b){_.defaults(a,{transaction:this.session.generateTransactionId(),apisecret:this.session.secret}),b=b||{},this._send(a,b)},Janus.Connection.prototype.close=function(a){this._close(a)},Janus.Connection.prototype._httpSetup=function(a){var b=this,c={janus:"create",transaction:this.session.generateTransactionId(),apisecret:this.session.secret};return a=a||{},$.ajax({type:"POST",url:this.server+"/janus",async:!0,cache:!1,contentType:"application/json",data:JSON.stringify(c),dataType:"json",success:function(c){b.connected=!0,a.success(c.data),b._httpPoll()},error:function(c,d,e){var f=d+" - "+e;b.connected=!1,a.error(f)}})},Janus.Connection.prototype._httpPoll=function(a){if(this.connected){var b=this,c={apisecret:this.session.secret},d={rid:(new Date).getTime()};return this.options.maxPolled&&(d.maxev=this.options.maxPolled),a=a||0,$.ajax({type:"GET",url:this.session.url(d),data:JSON.stringify(c),dataType:"json",cache:!1,timeout:this.options.pollTimeout,success:function(a){b.connected&&setTimeout(_.bind(b._httpPoll,b,0),b.options.pollFrequency),b.session.handleEvent(a)},error:function(c){return a++,a<b.options.maxPollRetries?void setTimeout(_.bind(b._httpPoll,b,a),b.options.pollFrequency):void(b.connected&&(0===c.status?b.session.trigger("janus:error","connection","Could not connect to the gateway "+a+"x. Is it down?"):b.session.trigger("janus:error","connection","Gateway rejected connnection "+a+"x. Try reconnecting."),b.session.disconnected()))}})}},Janus.Connection.prototype._httpSend=function(a,b){var c=this,d=b.plugin?b.plugin.url():this.session.url();return _.defaults(b,{sync:!1,type:"POST"}),b.success&&(c.session.transactions[a.transaction]=b.success),$.ajax({type:b.type,url:d,async:!b.sync,cache:!1,contentType:"application/json",data:JSON.stringify(a),dataType:"json",success:function(a){c.session.handleEvent(a)},error:function(d,e,f){if(a.transaction in c.session.transactions&&delete c.session.transactions[a.transaction],b.error){var g=e+" - "+f;b.error(g)}}})},Janus.Connection.prototype._httpClose=function(a){var b={janus:"destroy"};return this.connected=!1,this.send(b,a)},Janus.Connection.prototype._wsSetup=function(a){var b=this,c=new WebSocket(this.server,"janus-protocol");c.onclose=function(){b.connected=!1,b.session.disconnected(),b._ws&&(b._ws.close(),b._ws=null)},c.onerror=function(){},c.onmessage=function(a){var c=JSON.parse(a.data);b.session.handleEvent(c)},c.onopen=function(){b.connected=!0,b._wsKeepAlive(),b.send({janus:"create"},{success:function(b){a.success(b)}})},this._ws=c},Janus.Connection.prototype._wsSend=function(a,b){return b.success&&(this.session.transactions[a.transaction]=b.success),this.session.get("id")&&(a.session_id=this.session.get("id")),b.plugin&&b.plugin.get("id")&&(a.handle_id=b.plugin.get("id")),console.log(a),this._ws.send(JSON.stringify(a))},Janus.Connection.prototype._wsKeepAlive=function(){return this.connected?(this.session.get("id")&&this.send({janus:"keepalive"}),void setTimeout(_.bind(this._wsKeepAlive,this),this.options.keepAliveFrequency)):void console.info("exiting keep-alive loop")},Janus.Connection.prototype._wsClose=function(a){this._ws&&(this._ws.close(),this._ws=null),this.connected=!1,_.defer(a.success)},Janus.Plugin=Backbone.Model.extend({defaults:{id:null,sdp:null,sdpSent:!1,pc:null,dataChannel:null,iceTrickle:!0,iceDone:!1,localStream:null,media:{audioRecv:!1,audioSend:!1,videoRecv:!1,videoSend:!1,data:!1}},url:function(){return this.session.url()+"/"+this.get("id")},isAttached:function(){return void 0!==this.session&&null!==this.session&&null!==this.get("id")},attach:function(a,b){var c=this,d={janus:"attach",plugin:this.get("name")};return b=b||{},_.defaults(b,{sync:!1,success:_.noop,error:_.noop}),b.success=_.wrap(b.success,function(b,d){c.session=a,c.set("id",d.id),console.info("attached plugin '"+c.get("id")+"' to session '"+c.session.get("id")+"'"),c.session.plugins[c.get("id")]=c,b(d),c.trigger("janus:attach"),c.session.trigger("janus:attach",c)}),b.error=_.wrap(b.error,function(a,b){c.session=null,a(b),c.session.trigger("janus:error","attach",b)}),a.cxn.send(d,b)},detach:function(a){var b=this;a=a||{},_.defaults(a,{sync:!1,success:_.noop,error:_.noop}),a.success=_.wrap(a.success,function(c){console.info("detach: ",c),b.detached(),a.success()}),a.error=_.wrap(a.error,function(c){console.error(c),b.get("id")in b.session.plugins&&delete b.session.plugins[b.get("id")],b.detached(),a.error()})},detached:function(){var a=this.session;void 0!==a&&null!==a&&(this.get("id")in a.plugins&&delete a.plugins[this.get("id")],this.trigger("janus:detach"),a.trigger("janus:detach",this),this.session=null),this.set("id",null),this.hangupPeerConnection()},getUserMedia:function(a){a=a||{},_.defaults(a,{success:_.noop,error:_.noop});var b=this;return MediaStreamTrack.getSources(function(c){var d=c.some(function(a){return"audio"===a.kind}),e=c.some(function(a){return"video"===a.kind}),f={audio:d&&b.isAudioSendEnabled(),video:e&&b.isVideoSendEnabled()};getUserMedia(f,function(c){console.info("webrtc: getUserMedia",c),b.set("localStream",c),b.trigger("webrtc:localstream",c),a.success(c)},function(b){console.error("webrtc: getUserMedia failed",b),a.error(b)})})},createPeerConnection:function(a){a=a||{},_.defaults(a,{success:_.noop,error:_.noop});var b=this;if(!this.get("localStream")&&(this.isAudioSendEnabled()||this.isVideoSendEnabled()))return this.getUserMedia({success:function(){b.createPeerConnection(a)},error:a.error});var c=new RTCPeerConnection({iceServers:this.session.iceServers},this.session.pcConstraints);if(this.set("pc",c),this.get("localStream")&&(console.info("webrtc: local stream",this.get("localStream")),c.addStream(this.get("localStream"))),c.onaddstream=function(a){console.debug("webrtc: remote stream",a),b.trigger("webrtc:remotestream",a)},this.isDataEnabled()){var d=c.createDataChannel("janus",{ordered:!1});d.onmessage=function(a){b.trigger("webrtc:datachannel:message",a.data)},d.onopen=function(){b.trigger("webrtc:datachannel:opened")},d.onclose=function(a){b.trigger("webrtc:datachannel:closed",a.data)},d.onerror=function(a){b.trigger("webrtc:datachannel:error",a)},this.set("dataChannel",d)}c.ondatachannel=function(a){console.debug("webrtc: remote data channel",a),b.trigger("webrtc:datachannel",a)},c.onicecandidate=function(a){if(a.candidate){console.debug("webrtc: local ice candidate",a);var c={candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex};return b.sendIceCandidate(c),void b.trigger("webrtc:icecandidate",a)}console.debug("webrtc: all local ice candidates have been generated"),b.set("iceDone",!0),b.get("iceTrickle")?b.sendIceCandidate({completed:!0}):b.trigger("webrtc:icecomplete")},_.defer(a.success)},hangupPeerConnection:function(){this.get("localStream")&&(console.debug("webrtc: stopping local stream"),this.get("localStream").stop()),this.get("pc")&&(console.debug("webrtc: closing peer connection"),this.get("pc").close()),console.debug("webrtc: resetting state"),this.set("sdp",null),this.set("sdpSent",!1),this.set("pc",null),this.set("dataChannel",null),this.set("iceDone",!1),this.set("localStream",null)},hasDataChannel:function(){return null!==this.get("dataChannel")},sendData:function(a){console.debug("sending data through channel '"+this.get("dataChannel").label+"': ",a),this.get("dataChannel").send(a)},sendMessage:function(a,b){var c=this,d={janus:"message",body:a};return b=b||{},_.defaults(b,{plugin:this,success:_.noop,error:_.noop}),b.success=_.wrap(b.success,function(a,b){d.jsep&&c.set("sdpSent",!0),a(b)}),b.error=_.wrap(b.error,function(a,b){a(b)}),null!==b.jsep&&void 0!==b.jsep?d.jsep=b.jsep:this.get("sdp")&&!this.get("sdpSent")&&(d.jsep=this.get("sdp")),this.session.cxn.send(d,b)},sendIceCandidate:function(a,b){var c={janus:"trickle",candidate:null!==a?a:{completed:!0}};return b=b||{},_.defaults(b,{plugin:this,success:_.noop,error:_.noop}),this.session.cxn.send(c,b)},createOffer:function(a){a=a||{};var b=this,c={mandatory:{OfferToSendAudio:this.isAudioSendEnabled(),OfferToReceiveAudio:this.isAudioRecvEnabled(),OfferToSendVideo:this.isVideoSendEnabled(),OfferToReceiveVideo:this.isVideoRecvEnabled()}};console.log("webrtc: create offer",c),this.get("pc").createOffer(function(c){console.log("webrtc: created offer",c),(null===b.get("sdp")||void 0===b.get("sdp"))&&(console.log("webrtc: set local description",c),b.set("sdp",{type:"offer",sdp:c.sdp}),b.get("pc").setLocalDescription(c)),b.trigger("webrtc:offer",c),(a.success||_.noop)(c)},a.error||_.noop,c)},createAnswer:function(a){var b=this,c={mandatory:{OfferToReceiveAudio:this.isAudioRecvEnabled(),OfferToReceiveVideo:this.isVideoRecvEnabled()}};console.log("webrtc: create answer",c),this.get("pc").createAnswer(function(c){console.log("webrtc: created answer",c),(null===b.get("sdp")||void 0===b.get("sdp"))&&(console.log("webrtc: set local description to",c),b.set("sdp",{type:"answer",sdp:c.sdp}),b.get("pc").setLocalDescription(c)),b.trigger("webrtc:answer",c),(a.success||_.noop)(c)},a.error||_.noop,c)},handleEvent:function(a,b){var c=this;b&&(this.get("pc")?this.setRemoteDescription(b):this.createPeerConnection({success:function(){c.setRemoteDescription(b)}})),this.trigger("janus:event",a,b)},setRemoteDescription:function(a,b){var c=this;a instanceof RTCSessionDescription||(a=new RTCSessionDescription(a)),b=b||{},console.log("webrtc: setting remote description",a),this.get("pc").setRemoteDescription(a,function(){return console.log("webrtc: accepted remote description",a),"offer"==a.type?void c.createAnswer(b):void(b.success||_.noop)()},b.error||_.noop)},isAudioSendEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.audio===!1?!1:void 0===a.audioSend||null===a.audioSend?!0:a.audioSend===!0},isAudioRecvEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.audio===!1?!1:void 0===a.audioRecv||null===a.audioRecv?!0:a.audioRecv===!0},isVideoSendEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.video===!1?!1:void 0===a.videoSend||null===a.videoSend?!0:a.videoSend===!0},isVideoRecvEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.video===!1?!1:void 0===a.videoRecv||null===a.videoRecv?!0:a.videoRecv===!0},isDataEnabled:function(a){return 0===arguments.length&&(a=this.get("media")),void 0===a||null===a?!0:a.data===!0},attached:function(){function a(){c.off(null,a),d.resolve()}function b(){return c.isAttached()?void d.resolve():void c.once("janus:attach",a)}var c=this,d=$.Deferred();return _.defer(b),d},negotiated:function(){function a(){c.off(null,a),d.resolve()}function b(){return c.get("sdp")?void a():(c.once("webrtc:offer",a),void c.once("webrtc:answer",a))}var c=this,d=$.Deferred();return _.defer(b),d}}),Janus.Session=Backbone.Model.extend({defaults:{id:null},initialize:function(a,b){this.cxnConfig={server:b.urlRoot},this.cxn=null,this.secret=b.secret,this.transactions={},this.plugins={},this.iceServers=b.iceServers||[],this.pcConstraints=b.pcConstraints||null},url:function(a){return this.cxnConfig.server+"/janus/"+this.get("id")+(a?"?"+$.param(a):"")},connect:function(a){var b=this,c=null;return a=a||{},_.extend(a,this.cxnConfig),_.defaults(a,{session:this,success:_.noop,error:_.noop}),this.isConnected()?void _.defer(a.success):(a.success=_.wrap(a.success,function(a,d){console.log("create session",d),b.cxn=c,b.set("id",d.id),console.log("created session w/ id "+b.get("id")),b.trigger("janus:connect"),a(d)}),a.error=_.wrap(a.error,function(a,c){console.error("create session",c),b.cxn=null,b.trigger("janus:error","connect",c),a(c)}),void(c=new Janus.Connection(a)))},isConnected:function(){return null!==this.cxn},disconnect:function(a){var b=this;return a=a||{},_.defaults(a,{success:_.noop,error:_.noop}),a.success=_.wrap(a.success,function(a,c){b.disconnected(),a(c)}),a.error=_.wrap(a.error,function(a,c){b.disconnected(),a(c)}),this.isConnected()?this.cxn.close(a):_.defer(a.success)},reconnect:function(a){var b=this;return a=a||{},_.extend(a,this.cxnConfig),this.disconnect({success:function(){b.connect(a)},error:function(){b.connect(a)}})},disconnected:function(){var a=this.get("id");this.cxn=null,this.set("id",null),_.each(_.values(this.plugins),function(a){a.detached()}),this.plugins={},this.transactions={},this.trigger("janus:disconnect",a)},generateTransactionId:function(){return _.sample("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",12).join("")},handleEvent:function(a){function b(a){if(a in g.transactions){var b=g.transactions[a];return delete g.transactions[a],b}return _.noop}if(_.isArray(a))return void _.each(a,this.handleEvent);console.log("event for session "+this.get("id"),a);var c,d,e,f,g=this,h=a.sender,i=a.jsep;switch(a.janus){case"success":d=a.plugindata,void 0===d||null===d?b(a.transaction)(a.data):(console.info("event from "+h+" ("+d.plugin+")"),b(a.transaction)(d.data));break;case"error":f="error"in a?a.error:a,console.error("oops: "+f.code+" "+f.reason),b(a.transaction)(f);break;case"keepalive":break;case"ack":break;case"webrtcup":break;case"hangup":if(c=this.plugins[h],void 0===c||null===c){console.info("no plugin for sender '"+h+"'");break}c.detach();break;case"detached":if(c=this.plugins[h],void 0===c||null===c){console.info("no plugin for sender '"+h+"'");break}c.detach();break;case"event":if(void 0===h||null===h){console.warn("missing sender");break}if(d=a.plugindata,void 0===d||null===d)return void console.warn("missing plugindata");if(console.info("event from "+h+" ("+d.plugin+")"),e=d.data,c=this.plugins[h],void 0===c||null===c){console.info("no plugin for sender '"+h+"'");break}void 0!==i&&null!==i&&console.info("... and it came w/ SDP",i),c.handleEvent(e,i),b(a.transaction)(e,i);break;default:console.warn("unknown event '"+a.janus+"', ignoring ...")}},findPlugin:function(a){var b=_.findKey(this.plugins,a);return void 0!==b?this.plugins[b]:void 0}});